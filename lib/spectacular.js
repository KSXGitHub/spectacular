// Generated by CoffeeScript 1.6.2
var context, currentExample, currentExampleGroup, describe, fail, it, itsInstance, itsReturn, pending, rootExampleGroup, should, skip, spectacular, success, withParameters, xcontext, xdescribe, xit,
  __slice = [].slice,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

spectacular = spectacular || {};

String.prototype.capitalize = function() {
  return this.replace(/^(\w)/, function(m, c) {
    return c.toUpperCase();
  });
};

Function.prototype.include = function() {
  var excluded, k, mixin, mixins, v, _i, _len, _ref;

  mixins = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
  excluded = ['constructor'];
  for (_i = 0, _len = mixins.length; _i < _len; _i++) {
    mixin = mixins[_i];
    _ref = mixin.prototype;
    for (k in _ref) {
      v = _ref[k];
      if (__indexOf.call(excluded, k) < 0) {
        this.prototype[k] = v;
      }
    }
    if (typeof mixin.included === "function") {
      mixin.included(this);
    }
  }
  return this;
};

Function.prototype.extend = function() {
  var excluded, k, mixin, mixins, v, _i, _len;

  mixins = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
  excluded = ['name', 'prototype'];
  for (_i = 0, _len = mixins.length; _i < _len; _i++) {
    mixin = mixins[_i];
    for (k in mixin) {
      v = mixin[k];
      if (__indexOf.call(excluded, k) < 0) {
        this[k] = v;
      }
    }
    if (typeof mixin.extended === "function") {
      mixin.extended(this);
    }
  }
  return this;
};

Function.prototype.signature = function() {
  var re, _ref;

  re = /^function(\s+[a-zA-Z_][a-zA-Z0-9_]*)*\s*\(([^\)]+)\)/;
  return ((_ref = re.exec(this.toString())) != null ? _ref[2].split(/\s*,\s*/) : void 0) || [];
};

Function.prototype.getter = function(name, block) {
  return Object.defineProperty(this.prototype, name, {
    get: block,
    enumerable: true
  });
};

Function.prototype.setter = function(name, block) {
  return Object.defineProperty(this.prototype, name, {
    set: block,
    enumerable: true
  });
};

Function.prototype.accessor = function(name, options) {
  return Object.defineProperty(this.prototype, name, {
    get: options.get,
    get: options.set,
    enumerable: true
  });
};

spectacular.HasAncestors = (function() {
  function HasAncestors() {}

  HasAncestors.prototype.ancestors = function() {
    var ancestors, parent;

    ancestors = [];
    parent = this.parent;
    while (parent) {
      ancestors.push(parent);
      parent = parent.parent;
    }
    return ancestors;
  };

  return HasAncestors;

})();

spectacular.HasCollection = function(plural, singular) {
  var ConcreteHasCollection, capitalizedPlural, capitalizedSingular, mixin;

  capitalizedSingular = singular.capitalize();
  capitalizedPlural = plural.capitalize();
  mixin = ConcreteHasCollection = (function() {
    function ConcreteHasCollection() {}

    ConcreteHasCollection.included = function(ctor) {
      return ctor["" + plural + "Scope"] = function(name, block) {
        return ctor.getter(name, function() {
          return this[plural].filter(block);
        });
      };
    };

    return ConcreteHasCollection;

  })();
  mixin.prototype["add" + capitalizedSingular] = function() {
    var item, items, _i, _len, _results;

    items = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    _results = [];
    for (_i = 0, _len = items.length; _i < _len; _i++) {
      item = items[_i];
      if (__indexOf.call(this[plural], item) < 0) {
        _results.push(this[plural].push(item));
      }
    }
    return _results;
  };
  mixin.prototype["remove" + capitalizedSingular] = function() {
    var item, items, newArray, _i, _len, _ref;

    items = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    newArray = [];
    _ref = this[plural];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      item = _ref[_i];
      if (__indexOf.call(items, item) < 0) {
        newArray.push(item);
      }
    }
    return this[plural] = newArray;
  };
  mixin.prototype["" + singular + "At"] = function(index) {
    return this[plural][index];
  };
  mixin.prototype["find" + capitalizedSingular] = mixin.prototype["indexOf" + capitalizedSingular] = function(item) {
    return this[plural].indexOf(item);
  };
  mixin.prototype["has" + capitalizedSingular] = mixin.prototype["contains" + capitalizedSingular] = function(item) {
    return this[plural].indexOf(item) !== -1;
  };
  mixin.prototype["" + plural + "Length"] = mixin.prototype["" + plural + "Size"] = mixin.prototype["" + plural + "Count"] = function() {
    return this[plural].length;
  };
  return mixin;
};

spectacular.HasNestedCollection = function(name, options) {
  var ConcreteHasNestedCollection, mixin, through;

  if (options == null) {
    options = {};
  }
  through = options.through;
  if (through == null) {
    throw new Error('missing through option');
  }
  mixin = ConcreteHasNestedCollection = (function() {
    function ConcreteHasNestedCollection() {}

    ConcreteHasNestedCollection.included = function(ctor) {
      ctor["" + name + "Scope"] = function(scopeName, block) {
        return ctor.getter(scopeName, function() {
          return this[name].filter(block);
        });
      };
      return ctor.getter(name, function() {
        var items;

        items = [];
        this[through].forEach(function(item) {
          items.push(item);
          if (item[name] != null) {
            return items = items.concat(item[name]);
          }
        });
        return items;
      });
    };

    return ConcreteHasNestedCollection;

  })();
  return mixin;
};

spectacular.FollowUpProperty = function(property) {
  var ConcreteFollowUpProperty, capitalizedProperty, privateProperty;

  capitalizedProperty = property.capitalize();
  privateProperty = "own" + capitalizedProperty;
  return ConcreteFollowUpProperty = (function() {
    function ConcreteFollowUpProperty() {}

    ConcreteFollowUpProperty.included = function(ctor) {
      return ctor.getter(property, function() {
        var _ref;

        return this[privateProperty] || ((_ref = this.parent) != null ? _ref[property] : void 0);
      });
    };

    return ConcreteFollowUpProperty;

  })();
};

spectacular.MergeUpProperty = function(property) {
  var ConcreteMergeUpProperty, capitalizedProperty, privateProperty;

  capitalizedProperty = property.capitalize();
  privateProperty = "own" + capitalizedProperty;
  return ConcreteMergeUpProperty = (function() {
    function ConcreteMergeUpProperty() {}

    ConcreteMergeUpProperty.included = function(ctor) {
      return ctor.getter(property, function() {
        var a;

        a = this[privateProperty];
        if (this.parent != null) {
          a = this.parent[property].concat(a);
        }
        return a;
      });
    };

    return ConcreteMergeUpProperty;

  })();
};

spectacular.Describable = (function() {
  function Describable() {}

  Describable.included = function(ctor) {
    return ctor.getter('description', function() {
      var space, _ref;

      if (((_ref = this.parent) != null ? _ref.description : void 0) != null) {
        space = '';
        if (!this.noSpaceBeforeDescription) {
          space = ' ';
        }
        return "" + this.parent.description + space + this.ownDescription;
      } else {
        return this.ownDescription;
      }
    });
  };

  return Describable;

})();

spectacular.Promise = (function() {
  Promise.unit = function() {
    var promise;

    promise = new Promise();
    promise.resolve(0);
    return promise;
  };

  function Promise() {
    this.pending = true;
    this.fulfilled = null;
    this.value = void 0;
    this.fulfilledHandlers = [];
    this.errorHandlers = [];
    this.progressHandlers = [];
  }

  Promise.prototype.isPending = function() {
    return this.pending;
  };

  Promise.prototype.isFulfilled = function() {
    return !this.pending && this.fulfilled;
  };

  Promise.prototype.isRejected = function() {
    return !this.pending && !this.fulfilled;
  };

  Promise.prototype.then = function(fulfilledHandler, errorHandler, progressHandler) {
    var e, f, promise;

    promise = new spectacular.Promise;
    f = function(value) {
      if (typeof fulfilledHandler === "function") {
        fulfilledHandler(value);
      }
      return promise.resolve(value);
    };
    e = function(reason) {
      if (typeof errorHandler === "function") {
        errorHandler(reason);
      }
      return promise.reject(reason);
    };
    if (this.pending) {
      this.fulfilledHandlers.push(f);
      this.errorHandlers.push(e);
      if (progressHandler != null) {
        this.progressHandlers.push(progressHandler);
      }
    } else {
      if (this.fulfilled) {
        f(this.value);
      } else {
        e(this.reason);
      }
    }
    return promise;
  };

  Promise.prototype.fail = function(errorHandler) {
    return this.then((function() {}), errorHandler);
  };

  Promise.prototype.resolve = function(value) {
    this.value = value;
    if (!this.pending) {
      return;
    }
    this.fulfilled = true;
    this.notifyHandlers();
    return this.pending = false;
  };

  Promise.prototype.reject = function(reason) {
    this.reason = reason;
    if (!this.pending) {
      return;
    }
    this.fulfilled = false;
    this.notifyHandlers();
    return this.pending = false;
  };

  Promise.prototype.notifyHandlers = function() {
    var handler, _i, _j, _len, _len1, _ref, _ref1, _results, _results1;

    if (!this.pending) {
      return;
    }
    if (this.fulfilled) {
      _ref = this.fulfilledHandlers;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        handler = _ref[_i];
        _results.push(handler(this.value));
      }
      return _results;
    } else {
      _ref1 = this.errorHandlers;
      _results1 = [];
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        handler = _ref1[_j];
        _results1.push(handler(this.reason));
      }
      return _results1;
    }
  };

  return Promise;

})();

spectacular.AsyncExamplePromise = (function(_super) {
  __extends(AsyncExamplePromise, _super);

  function AsyncExamplePromise() {
    this.run = __bind(this.run, this);    this.interval = null;
    this.timeout = 5000;
    this.message = 'Timed out';
    AsyncExamplePromise.__super__.constructor.call(this);
  }

  AsyncExamplePromise.prototype.run = function() {
    var lastTime,
      _this = this;

    lastTime = new Date();
    return this.interval = setInterval(function() {
      if (new Date() - lastTime >= _this.timeout) {
        clearInterval(_this.interval);
        return _this.reject(new Error(_this.message));
      }
    }, 10);
  };

  AsyncExamplePromise.prototype.resolve = function(value) {
    clearInterval(this.interval);
    return AsyncExamplePromise.__super__.resolve.call(this, value);
  };

  AsyncExamplePromise.prototype.rejectAfter = function(timeout, message) {
    this.timeout = timeout;
    this.message = message;
  };

  return AsyncExamplePromise;

})(spectacular.Promise);

spectacular.Example = (function() {
  Example.include(spectacular.HasAncestors, spectacular.Describable, spectacular.FollowUpProperty('subjectBlock'), spectacular.MergeUpProperty('beforeHooks'), spectacular.MergeUpProperty('afterHooks'));

  function Example(block, ownDescription, parent) {
    this.block = block;
    this.ownDescription = ownDescription != null ? ownDescription : '';
    this.parent = parent;
    this.ownSubjectBlock = null;
    if (this.ownDescription === '') {
      this.noSpaceBeforeDescription = true;
    }
    this.ownBeforeHooks = [];
    this.ownAfterHooks = [];
    this.state = 'initialized';
  }

  Example.prototype.pending = function() {
    var _ref;

    if ((_ref = this.promise) != null ? _ref.pending : void 0) {
      this.promise.resolve();
      return this.state = 'pending';
    }
  };

  Example.prototype.skip = function() {
    var _ref;

    if ((_ref = this.promise) != null ? _ref.pending : void 0) {
      this.promise.reject(new Error('Skipped'));
      return this.state = 'skipped';
    }
  };

  Example.prototype.resolve = function() {
    var _ref;

    if ((_ref = this.promise) != null ? _ref.pending : void 0) {
      this.promise.resolve();
      return this.state = 'success';
    }
  };

  Example.prototype.reject = function(reason) {
    var _ref;

    if ((_ref = this.promise) != null ? _ref.pending : void 0) {
      this.promise.reject(reason);
      return this.state = 'failure';
    }
  };

  Example.prototype.run = function() {
    var async, e,
      _this = this;

    this.promise = new spectacular.Promise();
    try {
      if (this.acceptAsync(this.block)) {
        async = new spectacular.AsyncExamplePromise;
        async.then(function() {
          return _this.resolve();
        });
        async.fail(function(reason) {
          return _this.reject(reason);
        });
        async.run();
        this.block.call(this, async);
      } else {
        this.block.call(this);
        this.resolve();
      }
    } catch (_error) {
      e = _error;
      this.reject(e);
    }
    return this.promise;
  };

  Example.prototype.executeBlock = function() {
    return this.block.call(this);
  };

  Example.prototype.toString = function() {
    return "[Example(" + this.description + ")]";
  };

  Example.prototype.acceptAsync = function(func) {
    return func.signature().length === 1;
  };

  return Example;

})();

spectacular.ExampleGroup = (function(_super) {
  __extends(ExampleGroup, _super);

  ExampleGroup.include(spectacular.HasCollection('children', 'child'), spectacular.HasNestedCollection('descendants', {
    through: 'children'
  }));

  ExampleGroup.childrenScope('exampleGroups', function(e) {
    return e.children != null;
  });

  ExampleGroup.childrenScope('examples', function(e) {
    return e.children == null;
  });

  ExampleGroup.descendantsScope('allExamples', function(e) {
    return e.children == null;
  });

  ExampleGroup.prototype.parent = null;

  function ExampleGroup(block, desc, parent) {
    var subject,
      _this = this;

    subject = null;
    switch (typeof desc) {
      case 'string':
        if (desc.indexOf('.') === 0) {
          this.noSpaceBeforeDescription = true;
          subject = typeof this.subjectBlock === "function" ? this.subjectBlock()[desc.slice(1)] : void 0;
        } else if (desc.indexOf('::') === 0) {
          this.noSpaceBeforeDescription = true;
          subject = typeof this.subjectBlock === "function" ? this.subjectBlock().prototype[desc.slice(1)] : void 0;
        }
        break;
      default:
        this.noSpaceBeforeDescription = true;
        subject = desc;
        desc = (subject != null ? subject.name : void 0) || (subject != null ? subject.toString() : void 0) || '';
    }
    ExampleGroup.__super__.constructor.call(this, block, desc, parent);
    this.ownSubjectBlock = function() {
      if (subject != null) {
        return subject;
      }
    };
    this.children = [];
  }

  ExampleGroup.prototype.run = function() {};

  ExampleGroup.prototype.executeBlock = function() {
    return this.block.call(this);
  };

  ExampleGroup.prototype.toString = function() {
    return "[ExampleGroup(" + this.description + ")]";
  };

  return ExampleGroup;

})(spectacular.Example);

rootExampleGroup = new spectacular.ExampleGroup;

currentExampleGroup = rootExampleGroup;

currentExample = null;

spectacular.fail = function() {
  throw new Error('Failed');
};

spectacular.pending = function() {
  return currentExample.pending();
};

spectacular.skip = function() {
  return currentExample.skip();
};

spectacular.success = function() {};

spectacular.it = function(msgOrBlock, block) {
  var _ref;

  if (currentExample != null) {
    throw new Error('nested it declaration');
  }
  if (typeof msgOrBlock === 'function') {
    _ref = ['', msgOrBlock], msgOrBlock = _ref[0], block = _ref[1];
  }
  return currentExampleGroup.addChild(new spectacular.Example(block, msgOrBlock, currentExampleGroup));
};

spectacular.xit = function(msgOrBlock, block) {};

spectacular.itsInstance = function(block) {};

spectacular.itsReturn = function(block) {};

spectacular.describe = function(subject, block) {
  var oldGroup;

  oldGroup = currentExampleGroup;
  currentExampleGroup = new spectacular.ExampleGroup(block, subject, oldGroup);
  oldGroup.addChild(currentExampleGroup);
  currentExampleGroup.executeBlock();
  return currentExampleGroup = oldGroup;
};

spectacular.xdescribe = function(subject, block) {};

spectacular.context = spectacular.describe;

spectacular.xcontext = spectacular.xdescribe;

spectacular.withParameters = function() {
  var args;

  args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
};

spectacular.should = function(matcher) {};

it = spectacular.it, xit = spectacular.xit, describe = spectacular.describe, xdescribe = spectacular.xdescribe, context = spectacular.context, xcontext = spectacular.xcontext, itsInstance = spectacular.itsInstance, itsReturn = spectacular.itsReturn, withParameters = spectacular.withParameters, fail = spectacular.fail, pending = spectacular.pending, success = spectacular.success, skip = spectacular.skip, should = spectacular.should;

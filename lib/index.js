// Generated by CoffeeScript 1.6.2
var Q, Runner, fs, loadMatchers, m, path, vm, walk;

m = require('module');

fs = require('fs');

vm = require('vm');

Q = require('q');

path = require('path');

walk = require('walkdir');

Runner = require('./runner');

loadMatchers = function(options) {
  var defer, emitter;

  defer = Q.defer();
  if (options.noMatchers) {
    defer.resolve();
  } else {
    emitter = walk(options.matchersRoot);
    emitter.on('file', function(path, stat) {
      var k, matchers, v, _results;

      matchers = require(path);
      _results = [];
      for (k in matchers) {
        v = matchers[k];
        _results.push(global[k] = v);
      }
      return _results;
    });
    emitter.on('end', function() {
      return defer.resolve();
    });
  }
  return defer.promise;
};

exports.run = function(options) {
  var k, matchers, v;

  ['factories', 'spectacular'].forEach(function(file) {
    var filename, src;

    filename = path.resolve(__dirname, "" + file + ".js");
    src = fs.readFileSync(filename);
    return vm.runInThisContext(src, filename);
  });
  matchers = require('./matchers');
  for (k in matchers) {
    v = matchers[k];
    global[k] = v;
  }
  return loadMatchers(options).then(function() {
    return new Runner(rootExampleGroup, options).run();
  });
};
